# Story 8.3.1 - Standardized API Error Response Format

Goal: define and implement a single error response shape for all API endpoints.

## Prerequisites

1. Scaffold a minimal NestJS app (if not already present).
   - Target runtime: Node `24.11.0`
   - Package manager: npm
   - Location: `apps/api`
2. Enable global validation pipe (class-validator/class-transformer).
3. Add request ID middleware/interceptor to attach a correlation ID per request.

## Proposed Error Contract (RFC 7807 + Extensions)

```json
{
  "type": "https://bitstockerz.dev/errors/validation",
  "title": "Validation error",
  "status": 400,
  "detail": "One or more fields are invalid.",
  "instance": "/strategies",
  "code": "VALIDATION_ERROR",
  "requestId": "uuid-or-correlation-id",
  "fieldErrors": [
    { "field": "email", "reason": "invalid_format" }
  ]
}
```

Notes:
- `type`, `title`, `status`, `detail`, `instance` follow RFC 7807.
- `code` is stable for clients; `title`/`detail` are human-facing.
- `fieldErrors` is optional and only for validation errors.
- `requestId` must be populated from the correlation ID middleware.
- `type` should use a stable namespace (e.g., `https://bitstockerz.dev/errors/{code}`).
- `instance` should be the request path (no host), matching the incoming route.

## Error Code Catalog (Initial)

| code | http status | type suffix | title |
| --- | --- | --- | --- |
| VALIDATION_ERROR | 400 | validation | Validation error |
| UNAUTHORIZED | 401 | unauthorized | Unauthorized |
| FORBIDDEN | 403 | forbidden | Forbidden |
| NOT_FOUND | 404 | not-found | Not found |
| CONFLICT | 409 | conflict | Conflict |
| RATE_LIMITED | 429 | rate-limited | Rate limited |
| INTERNAL_ERROR | 500 | internal | Internal server error |

## Backend Tasks

1. Define error code enum and mapping table (HTTP status, default message).
2. Implement global error/exception filter in NestJS to wrap all errors in the contract.
3. Normalize validation errors (DTO/class-validator) into `details.fieldErrors`.
4. Add domain error base class for consistent `code`, `message`, `status`.
5. Ensure unknown errors return `INTERNAL_ERROR` with no stack traces in responses.
6. Add request ID to error payload (thread through logging/correlation middleware).
7. Update controller tests and add new error contract tests for common failure modes.
8. Document error contract in API inventory and share examples for clients.

## Acceptance Tests (Backend)

- For a malformed request body, API returns status 400 with:
  - `code = VALIDATION_ERROR`
  - `fieldErrors` populated
  - `requestId` present
- For unauthorized access, API returns status 401 with `code = UNAUTHORIZED`.
- For forbidden access, API returns status 403 with `code = FORBIDDEN`.
- For unknown route, API returns status 404 with `code = NOT_FOUND`.
- For duplicate resource (e.g., strategy name), API returns 409 with `code = CONFLICT`.
- For rate limit exceeded, API returns status 429 with `code = RATE_LIMITED`.
- For unhandled errors, API returns 500 with `code = INTERNAL_ERROR` and no stack trace.
- All error responses match RFC 7807 base fields plus required extensions (`code`, `requestId`, optional `fieldErrors`).
